<!DOCTYPE html>
<html style="width: 100%; height: 100%;" lang="en">
<head>
    <title>JDI Debugger View</title>
    <link rel="stylesheet" type="text/css" href="codemirror/lib/codemirror.css">
    <script src="codemirror/lib/codemirror.js"></script>
    <script src="codemirror/mode/clike/clike.js"></script>
    <style>
        body {
            width: 100%;
            height: 100%;
            margin: 0;
        }

        .verticalHalf {
            width: 100%;
            height: 50%;
        }

        .highlight {
            background-color: yellow;
        }

        .flex {
            display: flex;
        }

        .col {
            flex-direction: column;
        }

        .centered {
            justify-content: center;
            align-items: center;
        }

        .bbb {
            border-bottom: 1px solid black;
        }

        button {
            margin: 0 5px 0;
        }

        #controls {
            width: 100%;
            height: 50px;
        }

        .scrollable {
            overflow: scroll;
        }

        .flex-grow {
            flex-grow: 1;
        }

        .padded {
            padding: 5px;
        }

        .valueBox {
            height: calc(100% - 10px);
        }
    </style>
</head>
<body>
<div class="verticalHalf bbb" id="editor"></div>
<div class="verticalHalf flex col">
    <div id="controls" class="flex centered bbb">
        <button onclick="proceed(null)">Continue</button>
        <button onclick="proceed(2)">Step Over</button>
        <button onclick="proceed(1)">Step Into</button>
        <button onclick="proceed(3)">Step Out</button>
    </div>
    <div class="flex centered flex-grow">
        <div id="variableNames" class="flex col flex-grow scrollable padded valueBox"></div>
        <div id="variableValues" class="flex col flex-grow scrollable padded valueBox"></div>
    </div>
</div>
<script>
    let currentLocation = null;

    const editorDiv = document.getElementById("editor");
    const editor = CodeMirror(editorDiv, {
        lineNumbers: true,
        mode: "text/x-java",
        matchBrackets: true,
        readOnly: "nocursor"
    });

    editor.setSize("100%", "100%");

    async function proceed(depth) {
        currentLocation && setHighlightAtLine(currentLocation.lineNumber - 1, false);
        clear("variableNames");
        clear("variableValues");

        const body = {
            depth,
            previousLocation: currentLocation
        };
        const response = await (await fetch("/proceed", {
            method: "POST",
            body: JSON.stringify(body),
            headers: {"Content-Type": "application/json"}
        })).json();
        if (!response.updatedLocation) {
            for (const button of document.getElementsByTagName("button")) {
                button.disabled = true;
            }
            editor.setValue("");
            setTimeout(() => alert("Execution completed!"), 100);
            return;
        }

        const {updatedLocation, dereferencedVariables} = response;

        populate("variableNames", Object.keys(dereferencedVariables));
        populate("variableValues", Object.values(dereferencedVariables));

        if (!currentLocation || currentLocation.className !== updatedLocation.className) {
            editor.setValue(response.contentsAsString);
        }
        const lineNumber = (currentLocation = updatedLocation).lineNumber - 1;
        scrollToLine(lineNumber);
        setHighlightAtLine(lineNumber, true);
    }

    function populate(id, stringList) {
        const variableNames = document.getElementById(id);
        stringList.forEach(key => {
            const span = document.createElement("span");
            span.textContent = key;
            variableNames.appendChild(span);
        });
    }

    function clear(id) {
        const node = document.getElementById(id);
        while (node.firstChild) {
            node.removeChild(node.lastChild);
        }
    }

    function scrollToLine(i) {
        const t = editor.charCoords({line: i, ch: 0}, "local").top;
        const middleHeight = editor.getScrollerElement().offsetHeight / 2;
        editor.scrollTo(null, t - middleHeight - 5);
    }

    function setHighlightAtLine(i, flag) {
        const lineHandle = editor.getLineHandle(i);
        if (flag) {
            editor.addLineClass(lineHandle, "background", "highlight");
        } else {
            editor.removeLineClass(lineHandle, "background", "highlight");
        }
    }
</script>
</body>
</html>